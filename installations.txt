# Enable metallb for load balancing on cluster
# This will create 2 daemon sets controller and speaker and add a
# IPAddressPool and L2Advertisement with that range.
# Pool will only have one IP which is where port 80 and 443 are forearded from FW
kubectl microk8s enable metallb:192.168.50.10-192.168.50.10

# Enable ingress controller on node1
kubectl microk8s enable ingress

# Check that ingress controller is running
kubectl get pods -n ingress

# Must patch ingress controller to use metallb virtual IP
# Default seems to be HostPort which does fly at all
kubectl patch svc ingress-nginx-controller -n ingress -p '{"spec":{"type":"LoadBalancer"}}'

# Check metallb status should be 2 pods controller and speaker
kubectl get pods -n metallb-system

# Check if the ingress controller service got the external IP
kubectl get svc -n ingress

# Deploy all whoami components at once
kubectl apply -f whoami-complete.yaml


# Specifically look at the controller DaemonSet
kubectl get daemonset -n ingress
kubectl describe daemonset ingress-nginx-controller -n ingress | grep -i 'hostnetwork\|image'

# List the Service(s) it created
kubectl get svc -n ingress
kubectl describe svc ingress-nginx-controller -n ingress

# Confirm if itâ€™s using hostNetwork (common for MicroK8s)
kubectl get pods -n ingress -o yaml | grep -m1 -i hostNetwork

# Check arguments passed to the controller
kubectl logs -n ingress -l app=ingress-nginx --tail=50 | grep -- '--ingress-class'